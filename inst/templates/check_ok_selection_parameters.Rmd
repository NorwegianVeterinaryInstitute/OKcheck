---
output:
  html_document:
    keep_md: yes
params: 
    data: 
    purpose: "ok_sykdom_art"
    aar: "`r as.numeric(format(Sys.Date(), '%Y')) - 1`"
    accept: "accept_always"
title: "`r paste('Kontroll av seleksjonsparameterne for:', params$purpose, params$aar)`"
---
```{r set-options, echo=FALSE, cache=FALSE, clean=FALSE}
options(width = 1000)
```

```{r setup, include=FALSE}

# Attach packages
library(NVIbatch)
use_pkg(pkg = c("dplyr", "tidyr", "knitr", "kableExtra", "htmltools"))
use_NVIverse(pkg = c("NVIdb", "OKcheck"))

# Global variables
# For use in filenames
today <- format(Sys.Date(), "%Y%m%d")

# Import support data
# Translation table for PJS-codes
PJS_codes_2_text <- NVIdb::read_PJS_codes_2_text()

data <- params$data
purpose <- params$purpose
aar <- params$aar
accept <- params$accept

knitr::opts_chunk$set(echo=TRUE)
```

```{r, include = FALSE}
## Kontroll av seleksjonsparameterne for: `r purpose` `r aar` per `r format(Sys.Date(), "%d.%m.%Y")`

```

<!-- Check code combinations -->
```{r echo = FALSE}
heading <- paste("<br/> <br/>",
                 "<h4> Tabell K-4. Pr\u00F8ver med mer enn \u00E9n konklusjonskjennelse for identiske konklusjonsanalytter og",
                 "der konklusjonskjennelsene er motstridende </h4>",
                 "<h5> En pr\u00F8ve kan ikke konkluderes med motstridende pr\u00F8vekonklusjoner for samme pr\u00F8veanalytt.",
                 "Ber om at de pr\u00F8vekonklusjonene som er feil, fjernes fra saken. </h5>")

# Identify cases that need to be checked
ktr <- OKcheck::count_PJScodes(PJSdata = PJSdata, 
                               variable = "metodekode", 
                               accepted = metode2select,
                               translation_table = PJS_codes_2_text)

# Remove heading if no data to report
OKcheck::knit_table_if_data(data = ktr, heading = heading)


heading <- paste("<br/> <br/>",
                 "<h4> Tabell K-4. Pr\u00F8ver med mer enn \u00E9n konklusjonskjennelse for identiske konklusjonsanalytter og",
                 "der konklusjonskjennelsene er motstridende </h4>",
                 "<h5> En pr\u00F8ve kan ikke konkluderes med motstridende pr\u00F8vekonklusjoner for samme pr\u00F8veanalytt.",
                 "Ber om at de pr\u00F8vekonklusjonene som er feil, fjernes fra saken. </h5>")

# Identify cases that need to be checked
ktr <- OKcheck::count_PJScodes(PJSdata = PJSdata, 
                               variable = "hensiktkode", 
                               accepted = c(hensikt2select, hensikt2delete),
                               translation_table = PJS_codes_2_text)

# Remove heading if no data to report
OKcheck::knit_table_if_data(data = ktr, heading = heading)

heading <- paste("<br/> <br/>",
                 "<h4> Tabell K-4. Pr\u00F8ver med mer enn \u00E9n konklusjonskjennelse for identiske konklusjonsanalytter og",
                 "der konklusjonskjennelsene er motstridende </h4>",
                 "<h5> En pr\u00F8ve kan ikke konkluderes med motstridende pr\u00F8vekonklusjoner for samme pr\u00F8veanalytt.",
                 "Ber om at de pr\u00F8vekonklusjonene som er feil, fjernes fra saken. </h5>")

# Identify cases that need to be checked
ktr <- OKcheck::count_PJScodes(PJSdata = PJSdata,
                               variable = "konkl_analyttkode",
                               accepted = analytt2select,
                               translation_table = PJS_codes_2_text)

# Remove heading if no data to report
OKcheck::knit_table_if_data(data = ktr, heading = heading)

```

